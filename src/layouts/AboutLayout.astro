---
import type { MarkdownLayoutProps } from "astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import GitHubContributions from "@/components/GitHubContributions.tsx";
// import ContributionHeatmap from "@/components/ContributionHeatmap.astro";
import Layout from "./Layout.astro";
import { SITE } from "@/config";

type Props = MarkdownLayoutProps<{ title: string }>;

const { frontmatter } = Astro.props;
---

<Layout title={`${frontmatter.title} | ${SITE.title}`}>
  <Header />
  <Breadcrumb />
  <main id="main-content" class="app-layout">
    <section id="about" class="app-prose mb-28 max-w-app prose-img:border-0">
      <!-- Profile Header -->
      <div class="flex flex-col items-center mb-8 text-center">
        <!-- Avatar - 本地静态资源，最优加载性能 -->
        <a
          href="https://github.com/Carolier2003"
          target="_blank"
          rel="noopener noreferrer"
          class="block transition-transform hover:scale-105 mb-1"
        >
          <img
            src="/avatar.png"
            alt="Carol"
            width="100"
            height="100"
            class="rounded-full border-2 border-border shadow-md my-0"
            loading="eager"
            fetchpriority="high"
          />
        </a>

        <!-- Name -->
        <h2 class="text-xl font-bold mb-1 mt-0">Carol</h2>

        <!-- Subtitle -->
        <p class="text-foreground/70 text-sm mb-3">
          Java 后端工程师 · 终身学习者
        </p>

        <!-- Social Links -->
        <div class="flex items-center gap-3">
          <a
            href="https://github.com/Carolier2003"
            target="_blank"
            rel="noopener noreferrer"
            class="text-foreground/60 hover:text-accent transition-colors"
            title="GitHub"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
          </a>
          <a
            href="https://x.com/CarolG48818"
            target="_blank"
            rel="noopener noreferrer"
            class="text-foreground/60 hover:text-accent transition-colors"
            title="X (Twitter)"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
          </a>
          <a
            href="https://t.me/carolier233"
            target="_blank"
            rel="noopener noreferrer"
            class="text-foreground/60 hover:text-accent transition-colors"
            title="Telegram"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
            </svg>
          </a>
          <a
            href="mailto:jianjiale2003@gmail.com"
            class="text-foreground/60 hover:text-accent transition-colors"
            title="Email"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect width="20" height="16" x="2" y="4" rx="2"/>
              <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- Contribution Heatmap -->
      <div class="mb-8" id="contributions-container">
        <!-- Skeleton Screen -->
        <div id="contributions-skeleton" class="contribution-wrapper">
          <!-- Stats skeleton -->
          <div class="flex items-center gap-4 mb-4">
            <div class="h-4 w-48 bg-foreground/10 rounded animate-pulse"></div>
            <div class="h-4 w-24 bg-foreground/10 rounded animate-pulse hidden sm:block"></div>
            <div class="h-4 w-24 bg-foreground/10 rounded animate-pulse hidden sm:block"></div>
          </div>
          <!-- Heatmap skeleton -->
          <div class="heatmap-scroll-container">
            <div class="skeleton-grid">
              {Array.from({ length: 52 }).map((_, weekIndex) => (
                <div class="skeleton-week">
                  {Array.from({ length: 7 }).map((_, dayIndex) => (
                    <div class="skeleton-cell"></div>
                  ))}
                </div>
              ))}
            </div>
          </div>
          <!-- Legend skeleton -->
          <div class="flex items-center justify-end gap-2 mt-4">
            <div class="h-3 w-6 bg-foreground/10 rounded"></div>
            {Array.from({ length: 5 }).map(() => (
              <div class="w-3 h-3 rounded-sm bg-foreground/10"></div>
            ))}
            <div class="h-3 w-6 bg-foreground/10 rounded"></div>
          </div>
        </div>

        <!-- Loading indicator (hidden by default, shown on error retry) -->
        <div id="contributions-loading" class="text-center py-8" style="display: none;">
          <div class="inline-block w-6 h-6 border-2 border-accent/30 border-t-accent rounded-full animate-spin"></div>
          <p class="mt-2 text-sm text-foreground/60">Loading contributions...</p>
        </div>

        <!-- Error message (hidden by default) -->
        <div id="contributions-error" class="text-center py-8" style="display: none;">
          <p class="text-amber-500 text-sm">Failed to load contributions</p>
          <button id="retry-btn" class="mt-2 px-3 py-1 text-xs bg-accent/10 text-accent rounded hover:bg-accent/20 transition-colors">
            Retry
          </button>
        </div>

        <div id="contributions-content" style="display: none;" class="contribution-wrapper">
          <!-- Stats -->
          <div class="flex items-center gap-4 mb-4 text-xs text-foreground/60">
            <span><strong class="text-foreground" id="contrib-total">0</strong> contributions in the last year</span>
            <span class="hidden sm:inline">GitHub: <strong id="contrib-github">0</strong></span>
            <span class="hidden sm:inline">GitCode: <strong id="contrib-gitcode">0</strong></span>
          </div>
          <!-- SVG Heatmap -->
          <div class="heatmap-scroll-container">
            <svg id="contrib-svg" viewBox="0 0 740 121" preserveAspectRatio="xMidYMid meet">
              <!-- Month labels and cells will be inserted here -->
            </svg>
          </div>
          <!-- Legend -->
          <div class="flex items-center justify-end gap-2 mt-4 text-xs opacity-50">
            <span>Less</span>
            <div class="w-3 h-3 rounded-sm" style="background-color: #ebedf0;"></div>
            <div class="w-3 h-3 rounded-sm" style="background-color: rgba(0, 108, 172, 0.3);"></div>
            <div class="w-3 h-3 rounded-sm" style="background-color: rgba(0, 108, 172, 0.5);"></div>
            <div class="w-3 h-3 rounded-sm" style="background-color: rgba(0, 108, 172, 0.75);"></div>
            <div class="w-3 h-3 rounded-sm" style="background-color: rgb(0, 108, 172);"></div>
            <span>More</span>
          </div>
        </div>
      </div>

      <!-- Tooltip element -->
      <div id="contrib-tooltip" class="contrib-tooltip">
        <div class="contrib-tooltip-count" id="tooltip-count"></div>
        <div class="contrib-tooltip-sources" id="tooltip-sources"></div>
        <div class="contrib-tooltip-date" id="tooltip-date"></div>
      </div>

      <script is:inline>
        (function() {
          const API_BASE = location.hostname === 'localhost' ? 'http://localhost:8787' : 'https://api.kon-carol.xyz';
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const cellSize = 10;
          const cellGap = 3;

          // Tooltip element
          const tooltip = document.getElementById('contrib-tooltip');

          function getColor(level, isDark) {
            if (level === 0) return isDark ? '#2d333b' : '#ebedf0';
            const colors = ['',
              'rgba(0, 108, 172, 0.3)',
              'rgba(0, 108, 172, 0.5)',
              'rgba(0, 108, 172, 0.75)',
              'rgb(0, 108, 172)'
            ];
            return colors[level] || '#ebedf0';
          }

          function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          }

          function showTooltip(e, day) {
            const count = day.count;
            const githubCount = day.githubCount || 0;
            const gitcodeCount = day.gitcodeCount || 0;

            // Build tooltip content
            const countText = count === 0 ? 'No contributions' : count === 1 ? '1 contribution' : `${count} contributions`;
            document.getElementById('tooltip-count').textContent = countText;

            let sourcesHtml = '';
            if (githubCount > 0 || gitcodeCount > 0) {
              sourcesHtml = '';
              if (githubCount > 0) sourcesHtml += `<span>GitHub: ${githubCount}</span>`;
              if (gitcodeCount > 0) sourcesHtml += `<span>GitCode: ${gitcodeCount}</span>`;
            }
            document.getElementById('tooltip-sources').innerHTML = sourcesHtml;
            document.getElementById('tooltip-date').textContent = formatDate(day.date);

            // Position tooltip
            const rect = e.target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();

            let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
            let top = rect.top - tooltipRect.height - 8;

            // Boundary checks
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
              left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top < 10) {
              top = rect.bottom + 8;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.classList.add('visible');
          }

          function hideTooltip() {
            tooltip.classList.remove('visible');
          }

          function renderContributions(data) {
            document.getElementById('contrib-total').textContent = data.total.toLocaleString();
            document.getElementById('contrib-github').textContent = data.githubTotal.toLocaleString();
            document.getElementById('contrib-gitcode').textContent = data.gitcodeTotal.toLocaleString();

            const svg = document.getElementById('contrib-svg');
            svg.innerHTML = '';

            // Month labels
            months.forEach((month, i) => {
              const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
              text.setAttribute('x', 15 + i * 4.35 * (cellSize + cellGap));
              text.setAttribute('y', 15);
              text.setAttribute('font-size', 10);
              text.setAttribute('fill', 'currentColor');
              text.setAttribute('class', 'opacity-50');
              text.textContent = month;
              svg.appendChild(text);
            });

            // Contribution cells
            data.weeks.forEach((week, weekIndex) => {
              week.forEach((day, dayIndex) => {
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', 15 + weekIndex * (cellSize + cellGap));
                rect.setAttribute('y', 25 + dayIndex * (cellSize + cellGap));
                rect.setAttribute('width', cellSize);
                rect.setAttribute('height', cellSize);
                rect.setAttribute('rx', 2);
                rect.setAttribute('fill', getColor(day.level, false));
                rect.setAttribute('class', 'contrib-cell');
                rect.setAttribute('data-level', day.level);

                // Event listeners for tooltip
                rect.addEventListener('mouseenter', (e) => showTooltip(e, day));
                rect.addEventListener('mouseleave', hideTooltip);

                svg.appendChild(rect);
              });
            });

            document.getElementById('contributions-skeleton').style.display = 'none';
            document.getElementById('contributions-error').style.display = 'none';
            document.getElementById('contributions-content').style.display = 'flex';
          }

          async function fetchContributions() {
            // Check cache first
            const cached = sessionStorage.getItem('contributions');
            let hasStaleData = false;

            if (cached) {
              try {
                const data = JSON.parse(cached);
                // Use stale data immediately (up to 24 hours old)
                if (data.cachedAt && Date.now() - data.cachedAt < 24 * 60 * 60 * 1000) {
                  renderContributions(data);
                  hasStaleData = true;

                  // If cache is fresh (< 5 min), skip network request
                  if (Date.now() - data.cachedAt < 5 * 60 * 1000) {
                    return;
                  }
                }
              } catch (e) {
                // Invalid cache, continue to fetch
              }
            }

            // Only show skeleton if no stale data to display
            if (!hasStaleData) {
              document.getElementById('contributions-skeleton').style.display = 'flex';
              document.getElementById('contributions-content').style.display = 'none';
            }
            document.getElementById('contributions-error').style.display = 'none';

            try {
              const response = await fetch(`${API_BASE}/api/contributions`);
              if (response.ok) {
                const result = await response.json();
                if (result.success && result.data && result.data.weeks) {
                  // Update cache
                  result.data.cachedAt = Date.now();
                  sessionStorage.setItem('contributions', JSON.stringify(result.data));

                  // Only re-render if data changed significantly
                  if (!hasStaleData || JSON.stringify(result.data.weeks) !== JSON.stringify(JSON.parse(cached).weeks)) {
                    renderContributions(result.data);
                  }
                }
              }
            } catch (err) {
              console.error('Failed to fetch contributions:', err);
              // Don't show error if we have stale data
              if (!hasStaleData) {
                showError();
              }
            }
          }

          function showError() {
            document.getElementById('contributions-skeleton').style.display = 'none';
            document.getElementById('contributions-error').style.display = 'block';
          }

          // Retry button handler
          document.getElementById('retry-btn').addEventListener('click', fetchContributions);

          function renderMockData() {
            // Generate mock data for fallback
            const weeks = [];
            const today = new Date();
            for (let w = 0; w < 52; w++) {
              const week = [];
              for (let d = 0; d < 7; d++) {
                const date = new Date(today);
                date.setDate(today.getDate() - (52 - w) * 7 + d);
                const count = Math.random() > 0.6 ? Math.floor(Math.random() * 12) + 1 : 0;
                const level = count === 0 ? 0 : count <= 3 ? 1 : count <= 6 ? 2 : count <= 9 ? 3 : 4;
                week.push({
                  date: date.toISOString().split('T')[0],
                  count,
                  githubCount: count,
                  gitcodeCount: 0,
                  level
                });
              }
              weeks.push(week);
            }
            const total = weeks.flat().reduce((sum, d) => sum + d.count, 0);
            renderContributions({ weeks, total, githubTotal: total, gitcodeTotal: 0 });
          }

          // Fetch immediately
          fetchContributions();

          // Also fetch on View Transitions
          document.addEventListener('astro:page-load', fetchContributions);
        })();
      </script>

      <h1 class="text-2xl tracking-wider sm:text-3xl">{frontmatter.title}</h1>
      <slot />
    </section>
  </main>
  <Footer />

  <style is:global>
    /* Contribution Heatmap Styles */
    .contribution-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    .heatmap-scroll-container {
      width: 100%;
      overflow-x: auto;
      padding: 4px 0;
      display: flex;
      justify-content: center;
    }

    .heatmap-scroll-container::-webkit-scrollbar {
      height: 6px;
    }

    .heatmap-scroll-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .heatmap-scroll-container::-webkit-scrollbar-thumb {
      background: var(--foreground);
      opacity: 0.2;
      border-radius: 3px;
    }

    #contrib-svg {
      width: 100%;
      max-width: 720px;
      min-width: 680px;
      height: auto;
      color: var(--foreground);
    }

    .contrib-cell {
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .contrib-cell:hover {
      outline: 2px solid var(--accent);
      outline-offset: 1px;
      filter: brightness(1.1);
    }

    /* Skeleton Grid Styles */
    .skeleton-grid {
      display: flex;
      gap: 3px;
      padding: 25px 15px 10px;
      width: 100%;
      max-width: 720px;
      min-width: 680px;
    }

    .skeleton-week {
      display: flex;
      flex-direction: column;
      gap: 3px;
      flex-shrink: 0;
    }

    .skeleton-cell {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      background-color: var(--foreground);
      opacity: 0.1;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
    }

    /* Stagger animation for skeleton cells */
    .skeleton-week:nth-child(odd) .skeleton-cell:nth-child(odd) {
      animation-delay: 0s;
    }
    .skeleton-week:nth-child(odd) .skeleton-cell:nth-child(even) {
      animation-delay: 0.1s;
    }
    .skeleton-week:nth-child(even) .skeleton-cell:nth-child(odd) {
      animation-delay: 0.2s;
    }
    .skeleton-week:nth-child(even) .skeleton-cell:nth-child(even) {
      animation-delay: 0.3s;
    }

    @keyframes skeleton-pulse {
      0%, 100% {
        opacity: 0.1;
      }
      50% {
        opacity: 0.2;
      }
    }

    /* Tooltip */
    .contrib-tooltip {
      position: fixed;
      z-index: 1000;
      background: var(--background, #fff);
      border: 1px solid var(--border, #e1e4e8);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--foreground, #24292e);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      pointer-events: none;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s ease, visibility 0.15s ease;
    }

    .contrib-tooltip.visible {
      opacity: 1;
      visibility: visible;
    }

    .contrib-tooltip-count {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .contrib-tooltip-sources {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 2px;
    }

    .contrib-tooltip-sources span + span {
      margin-left: 8px;
    }

    .contrib-tooltip-date {
      font-size: 11px;
      opacity: 0.6;
    }

    /* Dark theme overrides */
    [data-theme="dark"] .contrib-cell[data-level="0"] {
      fill: #2d333b !important;
    }

    [data-theme="dark"] .contrib-cell[data-level="1"] {
      fill: rgba(255, 107, 1, 0.3) !important;
    }

    [data-theme="dark"] .contrib-cell[data-level="2"] {
      fill: rgba(255, 107, 1, 0.5) !important;
    }

    [data-theme="dark"] .contrib-cell[data-level="3"] {
      fill: rgba(255, 107, 1, 0.75) !important;
    }

    [data-theme="dark"] .contrib-cell[data-level="4"] {
      fill: rgb(255, 107, 1) !important;
    }

    [data-theme="dark"] .skeleton-cell {
      opacity: 0.08;
    }

    [data-theme="dark"] @keyframes skeleton-pulse {
      0%, 100% {
        opacity: 0.08;
      }
      50% {
        opacity: 0.15;
      }
    }
  </style>
</Layout>
