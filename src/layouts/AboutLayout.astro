---
import type { MarkdownLayoutProps } from "astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import GitHubContributions from "@/components/GitHubContributions.tsx";
// import ContributionHeatmap from "@/components/ContributionHeatmap.astro";
import Layout from "./Layout.astro";
import { SITE } from "@/config";

type Props = MarkdownLayoutProps<{ title: string }>;

const { frontmatter } = Astro.props;
---

<Layout title={`${frontmatter.title} | ${SITE.title}`}>
  <Header />
  <Breadcrumb />
  <main id="main-content" class="app-layout">
    <section id="about" class="app-prose mb-28 max-w-app prose-img:border-0">
      <!-- Profile Header -->
      <div class="flex flex-col items-center mb-8 text-center">
        <!-- Avatar -->
        <a
          href="https://github.com/Carolier2003"
          target="_blank"
          rel="noopener noreferrer"
          class="block transition-transform hover:scale-105 mb-1"
        >
          <img
            src="https://github.com/Carolier2003.png"
            alt="Carol"
            width="100"
            height="100"
            class="rounded-full border-2 border-border shadow-md my-0"
          />
        </a>

        <!-- Name -->
        <h2 class="text-xl font-bold mb-1 mt-0">Carol</h2>

        <!-- Subtitle -->
        <p class="text-foreground/70 text-sm mb-3">
          Java 后端工程师 · 终身学习者
        </p>

        <!-- Social Links -->
        <div class="flex items-center gap-3">
          <a
            href="https://github.com/Carolier2003"
            target="_blank"
            rel="noopener noreferrer"
            class="text-foreground/60 hover:text-accent transition-colors"
            title="GitHub"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
          </a>
          <a
            href="https://x.com/CarolG48818"
            target="_blank"
            rel="noopener noreferrer"
            class="text-foreground/60 hover:text-accent transition-colors"
            title="X (Twitter)"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
          </a>
          <a
            href="https://t.me/carolier233"
            target="_blank"
            rel="noopener noreferrer"
            class="text-foreground/60 hover:text-accent transition-colors"
            title="Telegram"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
            </svg>
          </a>
          <a
            href="mailto:jianjiale2003@gmail.com"
            class="text-foreground/60 hover:text-accent transition-colors"
            title="Email"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect width="20" height="16" x="2" y="4" rx="2"/>
              <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- Contribution Heatmap -->
      <div class="mb-8" id="contributions-container">
        <div id="contributions-loading" class="text-center py-8">
          <div class="inline-block w-6 h-6 border-2 border-accent/30 border-t-accent rounded-full animate-spin"></div>
          <p class="mt-2 text-sm text-foreground/60">Loading contributions...</p>
        </div>
        <div id="contributions-content" style="display: none;" class="overflow-x-auto flex flex-col items-center relative">
          <!-- Stats -->
          <div class="flex items-center gap-4 mb-4 text-xs text-foreground/60">
            <span><strong class="text-foreground" id="contrib-total">0</strong> contributions in the last year</span>
            <span class="hidden sm:inline">GitHub: <strong id="contrib-github">0</strong></span>
            <span class="hidden sm:inline">GitCode: <strong id="contrib-gitcode">0</strong></span>
          </div>
          <!-- SVG Heatmap -->
          <svg id="contrib-svg" viewBox="0 0 696 101" class="w-full min-w-[700px] mx-auto" style="max-width: 100%;">
            <!-- Month labels will be inserted here -->
          </svg>
          <!-- Legend -->
          <div class="flex items-center justify-end gap-2 mt-4 text-xs opacity-50">
            <span>Less</span>
            <div class="w-3 h-3 rounded-sm" style="background-color: #ebedf0;"></div>
            <div class="w-3 h-3 rounded-sm" style="background-color: rgba(0, 108, 172, 0.3);"></div>
            <div class="w-3 h-3 rounded-sm" style="background-color: rgba(0, 108, 172, 0.5);"></div>
            <div class="w-3 h-3 rounded-sm" style="background-color: rgba(0, 108, 172, 0.75);"></div>
            <div class="w-3 h-3 rounded-sm" style="background-color: rgb(0, 108, 172);"></div>
            <span>More</span>
          </div>
        </div>
      </div>

      <script is:inline>
        (function() {
          const API_BASE = 'https://api.kon-carol.xyz';
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const cellSize = 10;
          const cellGap = 3;

          function getColor(level, isDark) {
            if (level === 0) return isDark ? '#2d333b' : '#ebedf0';
            const colors = ['',
              'rgba(0, 108, 172, 0.3)',
              'rgba(0, 108, 172, 0.5)',
              'rgba(0, 108, 172, 0.75)',
              'rgb(0, 108, 172)'
            ];
            return colors[level] || '#ebedf0';
          }

          function renderContributions(data) {
            document.getElementById('contrib-total').textContent = data.total;
            document.getElementById('contrib-github').textContent = data.githubTotal;
            document.getElementById('contrib-gitcode').textContent = data.gitcodeTotal;

            const svg = document.getElementById('contrib-svg');
            svg.innerHTML = '';

            // Month labels
            months.forEach((month, i) => {
              const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
              text.setAttribute('x', 10 + i * 4.3 * (cellSize + cellGap));
              text.setAttribute('y', 15);
              text.setAttribute('font-size', 10);
              text.setAttribute('fill', 'currentColor');
              text.setAttribute('class', 'opacity-50');
              text.textContent = month;
              svg.appendChild(text);
            });

            // Contribution cells
            data.weeks.forEach((week, weekIndex) => {
              week.forEach((day, dayIndex) => {
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', 10 + weekIndex * (cellSize + cellGap));
                rect.setAttribute('y', 20 + dayIndex * (cellSize + cellGap));
                rect.setAttribute('width', cellSize);
                rect.setAttribute('height', cellSize);
                rect.setAttribute('rx', 2);
                rect.setAttribute('fill', getColor(day.level, false));
                rect.setAttribute('class', 'cursor-pointer');
                rect.setAttribute('data-level', day.level);
                rect.title = `${day.date}: ${day.count} contributions`;
                svg.appendChild(rect);
              });
            });

            document.getElementById('contributions-loading').style.display = 'none';
            document.getElementById('contributions-content').style.display = 'flex';
          }

          async function fetchContributions() {
            try {
              const response = await fetch(`${API_BASE}/api/contributions`);
              if (response.ok) {
                const result = await response.json();
                if (result.success) {
                  renderContributions(result.data);
                }
              }
            } catch (err) {
              console.error('Failed to fetch contributions:', err);
              document.getElementById('contributions-loading').innerHTML = '<p class="text-amber-500">Failed to load contributions</p>';
            }
          }

          // Fetch immediately
          fetchContributions();

          // Also fetch on View Transitions
          document.addEventListener('astro:page-load', fetchContributions);
        })();
      </script>

      <h1 class="text-2xl tracking-wider sm:text-3xl">{frontmatter.title}</h1>
      <slot />
    </section>
  </main>
  <Footer />
</Layout>
