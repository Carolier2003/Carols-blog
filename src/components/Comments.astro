---
interface Props {
  slug: string;
}

const { slug } = Astro.props;
const apiBase = "https://api.kon-carol.xyz";
---

<div class="comments-section" data-slug={slug} data-api={apiBase}>
  <div class="section-header">
    <h3>评论</h3>
    <span class="count" id="comments-count"></span>
  </div>

  <div class="comments-list" id="comments-list">
    <div class="loading">加载中...</div>
  </div>

  <div class="comment-form">
    <div class="form-title" id="form-title">写下评论</div>
    <form id="comment-form">
      <input type="hidden" id="parent-id" name="parent_id" value="" />

      <div class="form-fields">
        <input
          type="text"
          id="author-name"
          name="author_name"
          placeholder="名字"
          required
          maxlength="50"
        />
        <input
          type="email"
          id="author-email"
          name="author_email"
          placeholder="邮箱（头像用）"
        />
      </div>

      <textarea
        id="comment-content"
        name="content"
        placeholder="分享你的想法..."
        required
        maxlength="5000"
        rows="3"
      ></textarea>

      <div class="form-actions">
        <button type="button" class="btn-cancel" id="cancel-reply" style="display: none;">
          取消
        </button>
        <button type="submit" class="btn-submit">
          <span class="btn-text">发布</span>
          <span class="btn-loading" style="display: none;">...</span>
        </button>
      </div>

      <div class="form-message" id="form-message"></div>
    </form>
  </div>
</div>

<script>
  class CommentSystem {
    slug: string;
    apiBase: string;
    listEl: HTMLElement;
    formEl: HTMLFormElement;
    countEl: HTMLElement;
    messageEl: HTMLElement;
    formTitle: HTMLElement;
    cancelBtn: HTMLButtonElement;
    submitBtn: HTMLButtonElement;

    constructor(container: HTMLElement) {
      this.slug = container.dataset.slug || "";
      this.apiBase = container.dataset.api || "";
      this.listEl = container.querySelector("#comments-list")!;
      this.formEl = container.querySelector("#comment-form")!;
      this.countEl = container.querySelector("#comments-count")!;
      this.messageEl = container.querySelector("#form-message")!;
      this.formTitle = container.querySelector("#form-title")!;
      this.cancelBtn = container.querySelector("#cancel-reply")!;
      this.submitBtn = container.querySelector(".btn-submit")!;

      this.init();
    }

    init() {
      this.loadComments();
      this.bindEvents();
    }

    bindEvents() {
      this.formEl.addEventListener("submit", (e) => {
        e.preventDefault();
        this.submitComment();
      });

      this.cancelBtn.addEventListener("click", () => {
        this.clearReply();
      });

      this.listEl.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        if (target.classList.contains("reply-link")) {
          const commentId = target.dataset.id;
          const authorName = target.dataset.name;
          if (commentId && authorName) {
            this.setReply(commentId, authorName);
          }
        }
      });
    }

    async loadComments() {
      try {
        const response = await fetch(`${this.apiBase}/api/comments/${encodeURIComponent(this.slug)}`);
        const data = await response.json();

        if (data.success) {
          this.renderComments(data.comments, data.total);
        } else {
          this.listEl.innerHTML = '<div class="empty">加载失败</div>';
        }
      } catch (error) {
        console.error("Failed to load comments:", error);
        this.listEl.innerHTML = '<div class="empty">加载失败，请刷新</div>';
      }
    }

    renderComments(comments: any[], total: number) {
      this.countEl.textContent = total > 0 ? `${total}` : "";

      if (comments.length === 0) {
        this.listEl.innerHTML = '<div class="empty">暂无评论</div>';
        return;
      }

      const html = comments.map((comment) => this.renderComment(comment)).join("");
      this.listEl.innerHTML = html;
    }

    renderComment(comment: any): string {
      const date = new Date(comment.created_at).toLocaleDateString("zh-CN", {
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });

      const repliesHtml = comment.replies?.length
        ? `<div class="replies">${comment.replies.map((r: any) => this.renderComment(r)).join("")}</div>`
        : "";

      return `
        <div class="comment" id="comment-${comment.id}">
          <img src="${comment.avatar_url}" alt="" class="avatar" loading="lazy" />
          <div class="content">
            <div class="comment-header">
              <span class="name">${this.escapeHtml(comment.author_name)}</span>
              <span class="time">${date}</span>
            </div>
            <div class="text">${this.formatContent(comment.content)}</div>
            <div class="actions">
              <button class="reply-link" data-id="${comment.id}" data-name="${this.escapeHtml(comment.author_name)}">回复</button>
            </div>
            ${repliesHtml}
          </div>
        </div>
      `;
    }

    async submitComment() {
      const formData = new FormData(this.formEl);
      const data = {
        author_name: formData.get("author_name") as string,
        author_email: formData.get("author_email") as string,
        content: formData.get("content") as string,
        parent_id: formData.get("parent_id") ? parseInt(formData.get("parent_id") as string) : undefined,
      };

      this.setLoading(true);

      try {
        const response = await fetch(`${this.apiBase}/api/comments/${encodeURIComponent(this.slug)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          this.showMessage(result.message, "success");
          this.formEl.reset();
          this.clearReply();
          await this.loadComments();
        } else {
          this.showMessage(result.message || "发布失败", "error");
        }
      } catch (error) {
        this.showMessage("发布失败，请稍后重试", "error");
      } finally {
        this.setLoading(false);
      }
    }

    setLoading(loading: boolean) {
      const btnText = this.submitBtn.querySelector(".btn-text") as HTMLElement;
      const btnLoading = this.submitBtn.querySelector(".btn-loading") as HTMLElement;
      this.submitBtn.disabled = loading;
      if (btnText) btnText.style.display = loading ? "none" : "inline";
      if (btnLoading) btnLoading.style.display = loading ? "inline" : "none";
    }

    setReply(commentId: string, authorName: string) {
      const input = this.formEl.querySelector("#parent-id") as HTMLInputElement;
      input.value = commentId;
      this.formTitle.textContent = `回复 ${authorName}`;
      this.cancelBtn.style.display = "inline-block";
      this.formEl.scrollIntoView({ behavior: "smooth", block: "center" });
      (this.formEl.querySelector("#comment-content") as HTMLTextAreaElement).focus();
    }

    clearReply() {
      const input = this.formEl.querySelector("#parent-id") as HTMLInputElement;
      input.value = "";
      this.formTitle.textContent = "写下评论";
      this.cancelBtn.style.display = "none";
    }

    showMessage(message: string, type: "success" | "error") {
      this.messageEl.textContent = message;
      this.messageEl.className = `form-message ${type}`;
      setTimeout(() => {
        this.messageEl.textContent = "";
        this.messageEl.className = "form-message";
      }, 5000);
    }

    escapeHtml(text: string): string {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    formatContent(content: string): string {
      return this.escapeHtml(content).replace(/\n/g, "<br>");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".comments-section").forEach((container) => {
      new CommentSystem(container as HTMLElement);
    });
  });
</script>

<style is:global>
  /* ========================================
     GitHub Discussions Style Comments
     ======================================== */

  .comments-section {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
    font-size: 14px;
    line-height: 1.5;
  }

  /* Header */
  .section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    color: var(--foreground);
  }

  .section-header h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    letter-spacing: -0.025em;
  }

  .count {
    color: var(--muted);
    font-size: 0.875rem;
    font-weight: 400;
  }

  /* Comments List */
  .comments-list {
    margin-bottom: 2rem;
  }

  .loading,
  .empty {
    color: var(--muted);
    font-size: 14px;
    padding: 2rem;
    text-align: center;
    background: var(--background);
    border: 1px dashed var(--border);
    border-radius: 8px;
  }

  /* Individual Comment - GitHub Style */
  .comment {
    display: flex;
    gap: 12px;
    padding: 16px 0;
    position: relative;
  }

  .comment:first-child {
    padding-top: 0;
  }

  /* Avatar */
  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    flex-shrink: 0;
    border: 1px solid var(--border);
    background: var(--background);
    transition: transform 0.2s ease;
  }

  .avatar:hover {
    transform: scale(1.05);
  }

  /* Content Area */
  .content {
    flex: 1;
    min-width: 0;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--background);
  }

  /* Comment Header - Username + Timestamp */
  .comment-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: rgba(var(--accent-rgb, 0, 0, 0), 0.03);
    border-bottom: 1px solid var(--border);
    border-radius: 8px 8px 0 0;
  }

  .name {
    font-weight: 600;
    color: var(--foreground);
    font-size: 14px;
  }

  .time {
    font-size: 12px;
    color: var(--muted);
    font-weight: 400;
  }

  .time::before {
    content: "·";
    margin-right: 4px;
  }

  /* Comment Body */
  .text {
    color: var(--foreground);
    line-height: 1.6;
    word-break: break-word;
    font-size: 14px;
    padding: 12px 16px;
  }

  .text p {
    margin: 0 0 12px 0;
  }

  .text p:last-child {
    margin-bottom: 0;
  }

  /* Actions - Hidden by default, show on hover */
  .actions {
    display: flex;
    gap: 12px;
    padding: 0 16px 12px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .comment:hover .actions {
    opacity: 1;
  }

  .reply-link {
    font-size: 12px;
    color: var(--muted);
    background: transparent;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: color 0.2s;
    font-weight: 500;
  }

  .reply-link:hover {
    color: var(--accent);
    text-decoration: underline;
  }

  /* Nested Replies - GitHub Style Left Border */
  .replies {
    margin-top: 16px;
    margin-left: 20px;
    padding-left: 16px;
    border-left: 2px solid var(--border);
    display: flex;
    flex-direction: column;
  }

  .replies .comment {
    padding: 12px 0;
  }

  .replies .comment:first-child {
    padding-top: 0;
  }

  .replies .avatar {
    width: 32px;
    height: 32px;
  }

  .replies .content {
    border-color: var(--border);
  }

  /* Comment Form - GitHub Style */
  .comment-form {
    margin-top: 24px;
  }

  .form-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--foreground);
    margin-bottom: 12px;
  }

  .form-fields {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
  }

  .form-fields input {
    flex: 1;
    padding: 8px 12px;
    font-size: 14px;
    color: var(--foreground);
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: 6px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .form-fields input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(var(--accent-rgb, 0, 108, 172), 0.1);
  }

  .form-fields input::placeholder {
    color: var(--muted);
  }

  textarea {
    width: 100%;
    padding: 12px;
    font-size: 14px;
    color: var(--foreground);
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: 6px;
    outline: none;
    resize: vertical;
    min-height: 100px;
    margin-bottom: 12px;
    transition: border-color 0.2s, box-shadow 0.2s;
    font-family: inherit;
    line-height: 1.5;
  }

  textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(var(--accent-rgb, 0, 108, 172), 0.1);
  }

  textarea::placeholder {
    color: var(--muted);
  }

  .form-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .btn-submit,
  .btn-cancel {
    padding: 6px 16px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid;
  }

  .btn-submit {
    color: #fff;
    background: var(--accent);
    border-color: var(--accent);
  }

  .btn-submit:hover:not(:disabled) {
    filter: brightness(0.9);
  }

  .btn-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-cancel {
    color: var(--foreground);
    background: var(--background);
    border-color: var(--border);
  }

  .btn-cancel:hover {
    background: var(--border);
  }

  .form-message {
    margin-top: 8px;
    font-size: 14px;
    font-weight: 500;
  }

  .form-message.success {
    color: #1a7f37;
  }

  .form-message.error {
    color: #cf222e;
  }

  /* Mobile Responsive */
  @media (max-width: 640px) {
    .comment {
      gap: 10px;
    }

    .avatar {
      width: 36px;
      height: 36px;
    }

    .content {
      border-radius: 6px;
    }

    .comment-header {
      padding: 6px 12px;
      border-radius: 6px 6px 0 0;
    }

    .text {
      padding: 10px 12px;
    }

    .actions {
      padding: 0 12px 10px;
      opacity: 1; /* Always show on mobile */
    }

    .replies {
      margin-left: 10px;
      padding-left: 12px;
    }

    .replies .avatar {
      width: 28px;
      height: 28px;
    }

    .form-fields {
      flex-direction: column;
      gap: 8px;
    }
  }
</style>