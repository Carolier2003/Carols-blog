---
interface Props {
  slug: string;
}

const { slug } = Astro.props;
const apiBase = "https://api.kon-carol.xyz";
---

<div class="comments-wrapper" data-slug={slug} data-api={apiBase}>
  <div class="comments-header">
    <h2 class="comments-title">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
      </svg>
      评论
    </h2>
    <span class="comments-count" id="comments-count">加载中...</span>
  </div>

  <div class="comments-list" id="comments-list">
    <div class="loading-state">
      <div class="spinner"></div>
      <span>正在加载评论...</span>
    </div>
  </div>

  <div class="comment-form-container">
    <div class="form-header">
      <span class="form-label">发表评论</span>
      <span class="form-hint" id="reply-hint" style="display: none;"></span>
    </div>

    <form class="comment-form" id="comment-form">
      <input type="hidden" id="parent-id" name="parent_id" value="" />

      <div class="form-fields">
        <div class="input-group">
          <input
            type="text"
            id="author-name"
            name="author_name"
            placeholder="你的名字 *"
            required
            maxlength="50"
            autocomplete="name"
          />
          <input
            type="email"
            id="author-email"
            name="author_email"
            placeholder="邮箱（用于头像）"
            autocomplete="email"
          />
        </div>
        <input
          type="url"
          id="author-website"
          name="author_website"
          placeholder="个人网站（可选）"
          autocomplete="url"
        />
      </div>

      <textarea
        id="comment-content"
        name="content"
        placeholder="写下你的想法..."
        required
        maxlength="5000"
        rows="4"
      ></textarea>

      <div class="form-actions">
        <button type="button" class="btn-secondary" id="cancel-reply" style="display: none;">
          取消回复
        </button>
        <button type="submit" class="btn-primary">
          <span class="btn-text">发表评论</span>
          <span class="btn-loading" style="display: none;">发送中...</span>
        </button>
      </div>

      <div class="form-message" id="form-message"></div>
    </form>
  </div>
</div>

<script>
  class CommentSystem {
    private slug: string;
    private apiBase: string;
    private listEl: HTMLElement;
    private formEl: HTMLFormElement;
    private countEl: HTMLElement;
    private messageEl: HTMLElement;
    private replyHint: HTMLElement;
    private cancelBtn: HTMLButtonElement;
    private submitBtn: HTMLButtonElement;

    constructor(container: HTMLElement) {
      this.slug = container.dataset.slug || "";
      this.apiBase = container.dataset.api || "";
      this.listEl = container.querySelector("#comments-list")!;
      this.formEl = container.querySelector("#comment-form")!;
      this.countEl = container.querySelector("#comments-count")!;
      this.messageEl = container.querySelector("#form-message")!;
      this.replyHint = container.querySelector("#reply-hint")!;
      this.cancelBtn = container.querySelector("#cancel-reply")!;
      this.submitBtn = container.querySelector(".btn-primary")!;

      this.init();
    }

    private init() {
      this.loadComments();
      this.bindEvents();
    }

    private bindEvents() {
      this.formEl.addEventListener("submit", (e) => {
        e.preventDefault();
        this.submitComment();
      });

      this.cancelBtn.addEventListener("click", () => {
        this.clearReply();
      });

      this.listEl.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        if (target.classList.contains("reply-btn")) {
          const commentId = target.dataset.id;
          const authorName = target.dataset.name;
          if (commentId && authorName) {
            this.setReply(commentId, authorName);
          }
        }
      });
    }

    private async loadComments() {
      try {
        const response = await fetch(`${this.apiBase}/api/comments/${encodeURIComponent(this.slug)}`);
        const data = await response.json();

        if (data.success) {
          this.renderComments(data.comments, data.total);
        } else {
          this.listEl.innerHTML = '<div class="empty-state">加载失败，请刷新重试</div>';
        }
      } catch (error) {
        console.error("Failed to load comments:", error);
        this.listEl.innerHTML = '<div class="empty-state">加载失败，请刷新重试</div>';
      }
    }

    private renderComments(comments: any[], total: number) {
      this.countEl.textContent = total === 0 ? "暂无评论" : `${total} 条评论`;

      if (comments.length === 0) {
        this.listEl.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="empty-icon">
              <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 0 1-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <p>还没有评论，来说两句吧~</p>
          </div>
        `;
        return;
      }

      const html = comments.map((comment) => this.renderComment(comment)).join("");
      this.listEl.innerHTML = `<div class="comments-flow">${html}</div>`;
    }

    private renderComment(comment: any): string {
      const date = new Date(comment.created_at).toLocaleDateString("zh-CN", {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });

      const website = comment.author_website
        ? `<a href="${this.escapeHtml(comment.author_website)}" target="_blank" rel="noopener nofollow" class="author-website">
            ${new URL(comment.author_website).hostname}
          </a>`
        : "";

      const repliesHtml = comment.replies?.length
        ? `<div class="replies-thread">${comment.replies.map((r: any) => this.renderComment(r)).join("")}</div>`
        : "";

      return `
        <article class="comment-card" id="comment-${comment.id}">
          <img src="${comment.avatar_url}" alt="" class="comment-avatar" loading="lazy" width="40" height="40" />
          <div class="comment-body">
            <header class="comment-header">
              <div class="comment-meta">
                <span class="author-name">${this.escapeHtml(comment.author_name)}</span>
                ${website}
                <time class="comment-time" datetime="${comment.created_at}" title="${new Date(comment.created_at).toLocaleString("zh-CN")}">${date}</time>
              </div>
            </header>
            <div class="comment-content">${this.formatContent(comment.content)}</div>
            <footer class="comment-footer">
              <button type="button" class="reply-btn" data-id="${comment.id}" data-name="${this.escapeHtml(comment.author_name)}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                  <path d="M3 10h10a8 8 0 0 1 8 8v2M3 10l6 6m-6-6l6-6"/>
                </svg>
                回复
              </button>
            </footer>
            ${repliesHtml}
          </div>
        </article>
      `;
    }

    private async submitComment() {
      const formData = new FormData(this.formEl);
      const data = {
        author_name: formData.get("author_name") as string,
        author_email: formData.get("author_email") as string,
        author_website: formData.get("author_website") as string,
        content: formData.get("content") as string,
        parent_id: formData.get("parent_id") ? parseInt(formData.get("parent_id") as string) : undefined,
      };

      this.setLoading(true);

      try {
        const response = await fetch(`${this.apiBase}/api/comments/${encodeURIComponent(this.slug)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          this.showMessage(result.message, "success");
          this.formEl.reset();
          this.clearReply();
          await this.loadComments();
        } else {
          this.showMessage(result.message || "发布失败", "error");
        }
      } catch (error) {
        console.error("Failed to submit comment:", error);
        this.showMessage("发布失败，请稍后重试", "error");
      } finally {
        this.setLoading(false);
      }
    }

    private setLoading(loading: boolean) {
      const btnText = this.submitBtn.querySelector(".btn-text") as HTMLElement;
      const btnLoading = this.submitBtn.querySelector(".btn-loading") as HTMLElement;

      this.submitBtn.disabled = loading;
      if (btnText) btnText.style.display = loading ? "none" : "inline";
      if (btnLoading) btnLoading.style.display = loading ? "inline" : "none";
    }

    private setReply(commentId: string, authorName: string) {
      const input = this.formEl.querySelector("#parent-id") as HTMLInputElement;
      input.value = commentId;
      this.replyHint.textContent = `回复 ${authorName}`;
      this.replyHint.style.display = "inline";
      this.cancelBtn.style.display = "inline-flex";

      this.formEl.scrollIntoView({ behavior: "smooth", block: "center" });
      (this.formEl.querySelector("#comment-content") as HTMLTextAreaElement).focus();
    }

    private clearReply() {
      const input = this.formEl.querySelector("#parent-id") as HTMLInputElement;
      input.value = "";
      this.replyHint.style.display = "none";
      this.cancelBtn.style.display = "none";
    }

    private showMessage(message: string, type: "success" | "error") {
      this.messageEl.textContent = message;
      this.messageEl.className = `form-message ${type}`;
      setTimeout(() => {
        this.messageEl.textContent = "";
        this.messageEl.className = "form-message";
      }, 5000);
    }

    private escapeHtml(text: string): string {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    private formatContent(content: string): string {
      return this.escapeHtml(content).replace(/\n/g, "<br>");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".comments-wrapper").forEach((container) => {
      new CommentSystem(container as HTMLElement);
    });
  });
</script>

<style>
  .comments-wrapper {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border);
  }

  .comments-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }

  .comments-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--foreground);
    margin: 0;
  }

  .icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--accent);
  }

  .comments-count {
    font-size: 0.875rem;
    color: var(--muted);
  }

  /* 加载状态 */
  .loading-state {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 3rem;
    color: var(--muted);
    font-size: 0.875rem;
  }

  .spinner {
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* 空状态 */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    padding: 3rem 1.5rem;
    color: var(--muted);
    text-align: center;
  }

  .empty-icon {
    width: 3rem;
    height: 3rem;
    opacity: 0.4;
  }

  .empty-state p {
    margin: 0;
    font-size: 0.875rem;
  }

  /* 评论列表 */
  .comments-flow {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* 评论卡片 */
  .comment-card {
    display: flex;
    gap: 0.875rem;
    padding: 1rem;
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .comment-card:hover {
    border-color: var(--accent);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .comment-avatar {
    flex-shrink: 0;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    background: var(--muted);
  }

  .comment-body {
    flex: 1;
    min-width: 0;
  }

  .comment-header {
    margin-bottom: 0.5rem;
  }

  .comment-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.375rem 0.75rem;
  }

  .author-name {
    font-weight: 600;
    color: var(--foreground);
    font-size: 0.9375rem;
  }

  .author-website {
    font-size: 0.75rem;
    color: var(--accent);
    text-decoration: none;
    opacity: 0.8;
  }

  .author-website:hover {
    opacity: 1;
    text-decoration: underline;
  }

  .comment-time {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .comment-content {
    color: var(--foreground);
    line-height: 1.6;
    font-size: 0.9375rem;
    word-break: break-word;
  }

  .comment-footer {
    margin-top: 0.75rem;
  }

  .reply-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
    color: var(--muted);
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .reply-btn:hover {
    color: var(--accent);
    border-color: var(--accent);
    background: var(--background);
  }

  /* 回复嵌套 */
  .replies-thread {
    margin-top: 0.875rem;
    padding-left: 0.5rem;
    border-left: 2px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 0.875rem;
  }

  .replies-thread .comment-card {
    padding: 0.75rem;
    background: transparent;
    border: none;
    border-radius: 0;
  }

  .replies-thread .comment-card:hover {
    box-shadow: none;
  }

  .replies-thread .comment-avatar {
    width: 2rem;
    height: 2rem;
  }

  /* 评论表单 */
  .comment-form-container {
    margin-top: 2rem;
    padding: 1.25rem;
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: 0.75rem;
  }

  .form-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .form-label {
    font-weight: 600;
    color: var(--foreground);
    font-size: 0.9375rem;
  }

  #reply-hint {
    font-size: 0.8125rem;
    color: var(--accent);
    padding: 0.25rem 0.625rem;
    background: var(--accent);
    background-opacity: 0.1;
    border-radius: 0.25rem;
  }

  .form-fields {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .input-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }

  @media (max-width: 480px) {
    .input-group {
      grid-template-columns: 1fr;
    }
  }

  .comment-form input,
  .comment-form textarea {
    width: 100%;
    padding: 0.625rem 0.875rem;
    font-size: 0.9375rem;
    color: var(--foreground);
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .comment-form input::placeholder,
  .comment-form textarea::placeholder {
    color: var(--muted);
    opacity: 0.7;
  }

  .comment-form input:focus,
  .comment-form textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
  }

  .comment-form textarea {
    resize: vertical;
    min-height: 100px;
    margin-bottom: 0.75rem;
  }

  .form-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .btn-primary,
  .btn-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 1.25rem;
    font-size: 0.9375rem;
    font-weight: 500;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }

  .btn-primary {
    color: white;
    background: var(--accent);
  }

  .btn-primary:hover:not(:disabled) {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-secondary {
    color: var(--foreground);
    background: var(--border);
  }

  .btn-secondary:hover {
    opacity: 0.8;
  }

  .form-message {
    margin-top: 0.75rem;
    padding: 0.625rem 0.875rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }

  .form-message.success {
    color: #166534;
    background: #dcfce7;
    border: 1px solid #bbf7d0;
  }

  .form-message.error {
    color: #991b1b;
    background: #fee2e2;
    border: 1px solid #fecaca;
  }

  /* 暗色模式适配 */
  :global([data-theme="dark"]) .comment-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  :global([data-theme="dark"]) .form-message.success {
    background: #14532d;
    color: #86efac;
    border-color: #166534;
  }

  :global([data-theme="dark"]) .form-message.error {
    background: #7f1d1d;
    color: #fca5a5;
    border-color: #991b1b;
  }
</style>
