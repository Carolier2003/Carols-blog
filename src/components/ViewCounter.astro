---
/**
 * æµè§ˆé‡æ˜¾ç¤ºç»„ä»¶
 * ç”¨äºåœ¨æ–‡ç« å¡ç‰‡å’Œè¯¦æƒ…é¡µæ˜¾ç¤ºæ–‡ç« æµè§ˆé‡
 */
interface Props {
  slug: string;
  variant?: "full" | "compact";
  initialCount?: number;
}

const { slug, variant = "full", initialCount = 0 } = Astro.props;

// API åŸºç¡€ URL
const API_BASE = "https://api.kon-carol.xyz";

// æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º (å¦‚: 1200 -> 1.2k)
function formatCount(num: number): string {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + "M";
  }
  if (num >= 1000) {
    return (num / 1000).toFixed(1) + "k";
  }
  return num.toString();
}
---

<span
  class:list={["view-counter", variant]}
  data-slug={slug}
  data-variant={variant}
  data-initial={initialCount}
>
  {variant === "full" && <span class="icon">ğŸ‘</span>}
  <span class="count">{initialCount > 0 ? formatCount(initialCount) : "--"}</span>
  {variant === "full" && <span class="label">é˜…è¯»</span>}
</span>

<script define:vars={{ API_BASE }}>
  // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º (å¦‚: 1200 -> 1.2k)
  function formatCount(num) {
    if (num >= 1000000) {
      return (num / 1000000).toFixed(1) + "M";
    }
    if (num >= 1000) {
      return (num / 1000).toFixed(1) + "k";
    }
    return num.toString();
  }

  // è·å–æ‰€æœ‰æµè§ˆé‡è®¡æ•°å™¨å…ƒç´ 
  const counters = document.querySelectorAll(".view-counter");

  // æ‰¹é‡è·å–æµè§ˆé‡
  async function fetchViewCounts() {
    const slugs = [];
    const elements = [];

    counters.forEach((el) => {
      const slug = el.dataset.slug;
      if (slug) {
        slugs.push(slug);
        elements.push(el);
      }
    });

    if (slugs.length === 0) return;

    // é€ä¸ªè·å–ï¼ˆå› ä¸º API ç›®å‰åªæ”¯æŒå•ä¸ªæŸ¥è¯¢ï¼‰
    for (let i = 0; i < slugs.length; i++) {
      const slug = slugs[i];
      const el = elements[i];

      try {
        const response = await fetch(`${API_BASE}/api/views/${encodeURIComponent(slug)}`);
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            const countEl = el.querySelector(".count");
            if (countEl) {
              countEl.textContent = formatCount(data.view_count);
            }
          }
        }
      } catch (error) {
        // é™é»˜å¤±è´¥ï¼Œä¿æŒæ˜¾ç¤ºåˆå§‹å€¼
        console.debug("Failed to fetch view count:", error);
      }
    }
  }

  // é¡µé¢åŠ è½½åè·å–æµè§ˆé‡
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", fetchViewCounts);
  } else {
    fetchViewCounts();
  }
</script>

<style>
  .view-counter {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--color-fg-muted, #6e7781);
    font-size: 0.875rem;
  }

  .view-counter.full {
    gap: 0.375rem;
  }

  .view-counter.compact {
    font-size: 0.8rem;
  }

  .icon {
    opacity: 0.7;
  }

  .count {
    font-variant-numeric: tabular-nums;
  }

  .label {
    opacity: 0.8;
  }
</style>
