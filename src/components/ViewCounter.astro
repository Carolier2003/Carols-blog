---
/**
 * 浏览量显示组件
 * 用于在文章卡片和详情页显示文章浏览量
 */
import IconEye from "@/assets/icons/IconEye.svg";
import { formatCount } from "@/utils/viewCounter";

interface Props {
  slug: string;
  variant?: "full" | "compact";
  initialCount?: number;
  immediate?: boolean; // 是否立即加载（详情页用）
}

const { slug, variant = "full", initialCount = 0, immediate = false } = Astro.props;
---

<span
  class:list={["view-counter", variant]}
  data-slug={slug}
  data-variant={variant}
  data-initial={initialCount}
  data-immediate={String(immediate)}
>
  <IconEye class:list={["inline-block", { "size-5": variant === "full", "size-4": variant === "compact" }]} />
  <span class="count">--</span>
  {variant === "full" && <span class="label">阅读</span>}
  {variant === "compact" && <span class="label">次阅读</span>}
</span>

<script is:inline>
  // ViewCounter inline script - loaded directly in HTML
  // Note: Using inline script to ensure immediate execution without module bundling issues
  const VIEW_API_BASE = "https://api.kon-carol.xyz";

  function formatCount(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
    if (num >= 1000) return (num / 1000).toFixed(1) + "k";
    return num.toString();
  }

  function getCachedViews() {
    try {
      const cached = sessionStorage.getItem("viewCounts");
      const timestamp = sessionStorage.getItem("viewCountsTimestamp");
      if (cached && timestamp && Date.now() - parseInt(timestamp) < 300000) {
        return JSON.parse(cached);
      }
    } catch (e) {
      console.debug("Failed to read cache:", e);
    }
    return {};
  }

  function setCachedViews(views) {
    try {
      sessionStorage.setItem("viewCounts", JSON.stringify(views));
      sessionStorage.setItem("viewCountsTimestamp", Date.now().toString());
    } catch (e) {
      console.debug("Failed to write cache:", e);
    }
  }

  function isValidBatchResponse(data) {
    return data && typeof data === "object" && data.success === true &&
           typeof data.views === "object" && data.views !== null && !Array.isArray(data.views);
  }

  function initViewCounter() {
    // 确保在浏览器环境执行
    if (typeof window === "undefined" || typeof document === "undefined") return;

    // 防止重复初始化：如果已经初始化过，直接跳过
    const win = window;
    if (win.__viewCounterInit) {
      return;
    }
    win.__viewCounterInit = true;

    // 批量获取浏览量（只执行一次）
    async function fetchViewCounts() {
      // 获取所有浏览量计数器元素（每次执行时动态获取，确保获取到所有实例）
      const counters = document.querySelectorAll(".view-counter");
      const slugs = [];
      const slugToElements = new Map();

      counters.forEach((el) => {
        const slug = el.dataset.slug;
        if (slug) {
          slugs.push(slug);
          if (!slugToElements.has(slug)) {
            slugToElements.set(slug, []);
          }
          const elements = slugToElements.get(slug);
          if (elements) elements.push(el);
        }
      });

      if (slugs.length === 0) return;

      // 先去重，避免重复查询
      const uniqueSlugs = [...new Set(slugs)];

      // 先尝试从缓存读取
      const cachedViews = getCachedViews();
      const slugsToFetch = [];
      const result = { ...cachedViews };

      uniqueSlugs.forEach((slug) => {
        if (cachedViews[slug] === undefined) {
          slugsToFetch.push(slug);
        }
      });

      // 如果有需要查询的 slug，批量获取（使用 GET 以便 CDN 缓存）
      if (slugsToFetch.length > 0) {
        try {
          const slugsParam = slugsToFetch.join(",");
          const response = await fetch(
            `${VIEW_API_BASE}/api/views/batch?slugs=${encodeURIComponent(slugsParam)}`
          );

          if (response.ok) {
            const data = await response.json();
            if (isValidBatchResponse(data)) {
              // 合并到结果
              Object.assign(result, data.views);
              // 更新缓存
              Object.assign(cachedViews, data.views);
              setCachedViews(cachedViews);
            }
          }
        } catch (error) {
          console.debug("Failed to fetch batch view counts:", error);
        }
      }

      // 更新所有计数器显示
      uniqueSlugs.forEach((slug) => {
        const elements = slugToElements.get(slug);
        const count = result[slug] ?? 0;
        elements?.forEach((el) => {
          const countEl = el.querySelector(".count");
          if (countEl) {
            countEl.textContent = formatCount(count);
          }
        });
      });
    }

    // 页面加载后获取浏览量
    // 详情页使用 immediate=true 立即加载，其他页面使用 requestIdleCallback 延迟执行
    const counters = document.querySelectorAll(".view-counter");
    const hasImmediate = Array.from(counters).some(
      (el) => el.dataset.immediate === "true"
    );

    const scheduleFetch = () => {
      if (hasImmediate) {
        // 详情页：立即执行
        fetchViewCounts();
      } else {
        // 列表页：延迟执行，优先保证页面渲染
        if ("requestIdleCallback" in window) {
          requestIdleCallback(fetchViewCounts, { timeout: 2000 });
        } else {
          setTimeout(fetchViewCounts, 100);
        }
      }
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", scheduleFetch);
    } else {
      scheduleFetch();
    }
  }

  initViewCounter();
</script>

<style>
  .view-counter {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    opacity: 0.8;
    font-size: 0.875rem;
  }

  .view-counter.full {
    gap: 0.375rem;
  }

  .view-counter.compact {
    font-size: 0.8rem;
  }

  .count {
    font-variant-numeric: tabular-nums;
  }
</style>
